

WITH CUSTOMER_ORDERS AS (
SELECT 
    C.CUSTOMERID,
    CONCAT(C.FIRSTNAME, ' ', C.LASTNAME) AS CUSTOMERNAME,
    COUNT(O.ORDERID) AS NO_OF_ORDERS
FROM 
    "dbt_prod"."cayoty"."customers" C
JOIN 
    "dbt_prod"."cayoty"."orders" O ON C.CUSTOMERID = O.CUSTOMERID
GROUP BY 
    C.CUSTOMERID, CUSTOMERNAME
ORDER BY 
    NO_OF_ORDERS DESC
)

SELECT CUSTOMERID, CUSTOMERNAME, NO_OF_ORDERS FROM CUSTOMER_ORDERS